# CHANGELOG

## [Unreleased]

### バグ修正

- **YamlDocGeneratorのspec変数未割り当て問題を修正**: `YamlDocGenerator.__init__`メソッドで`spec_obj`の変換処理後に`spec`変数が正しく割り当てられない可能性があった問題を修正
  - 変換処理後に`spec_obj`を正規化し、`TypeRoot`/`TypeSpec`に応じて適切に`spec`を割り当て
  - これにより`_generate_header`/`_generate_body`呼び出し前に`spec`が常に束縛されることを保証

### 改善

- **ruff v0.14.0へのアップグレード**: 開発環境とCI環境のバージョン整合性を確保
  - `pyproject.toml`の依存関係を`ruff>=0.14.0`に更新
  - `.pre-commit-config.yaml`の`ruff-pre-commit`を`v0.14.0`に更新
  - 不要な`# noqa: UP038`ディレクティブを削除（UP038ルールが削除されたため）

### 開発環境

- **pre-commit設定の更新**: ruff-pre-commitを最新バージョンに統一
- **PR review workflowの実行**: レビュータスクの体系的処理を実施

---

## [0.5.1] - 2025年10月11日

### ドキュメント
- **ドキュメントと実装の整合性を修正**: 実装されていないTUI関連の記述を全削除し、CLIのみに統一
  - AGENTS.md/CLAUDE.mdのディレクトリ構造を現在の実装に合わせて更新
  - cli/commands/配下を実際のファイル名（check.py, docs.py, init.py, types.py, yaml.py）に修正
  - core/配下の構造を正確に反映（analyzer/, utils/の詳細追加）
  - Phase 3を「CLIインターフェース実装 - 完了」に修正
  - Phase 4を「完了」に更新
  - Phase 7を「PyPI公開とパッケージング完了（v0.1.0〜v0.1.4リリース済み）」に更新

---

## [0.5.0] - 2025年10月

### 破壊的変更 (BREAKING CHANGES)
- **CLIコマンドを1語形式に統一** (#50): ハイフン区切りの2語コマンドを廃止し、シンプルな1語コマンドに統一
  - 旧: `pylay convert to-yaml` → 新: `pylay yaml`
  - 旧: `pylay convert to-type` → 新: `pylay types`
  - 旧: `pylay generate yaml-docs` → 新: `pylay docs`
  - `pylay quality`コマンドは変更なし（既に1語コマンド）

### 新機能
- **新しい1語コマンドの追加**:
  - `pylay yaml <target>`: Python型からYAML仕様を生成
  - `pylay types <yaml>`: YAML仕様からPython型を生成
  - `pylay docs`: YAML仕様からMarkdownドキュメントを生成

### 改善
- **ユーザビリティの向上**: タイプ量の削減とコマンドの直感性向上
- **一貫性の確保**: 全コマンドを1語形式で統一
- **拡張性の向上**: 新しいコマンドを追加しやすい構造

### 移行ガイド
既存のコマンドを新しい形式に置き換えるだけで、オプションやフラグはそのまま使用できます：
```bash
# 旧コマンド → 新コマンド
pylay convert to-yaml input.py -o output.yaml  → pylay yaml input.py -o output.yaml
pylay convert to-type input.yaml -o output.py  → pylay types input.yaml -o output.py
pylay generate yaml-docs input.yaml -o docs/   → pylay docs -i input.yaml -o docs/
```

---

## [0.4.0] - 2025年10月

### 新機能
- **NewType + ファクトリ関数パターンへの移行完了** (#48): Level 2型定義をPEP 484準拨のNewTypeパターンに統一
  - 非推奨の`Annotated`直接使用を完全排除し、`NewType` + ファクトリ関数 + `TypeAdapter`パターンに移行
  - `@validate_call`デコレータパターンのサポートを追加
  - 品質チェックコマンドでNewTypeの直接使用を検出し、ファクトリ関数使用を推奨
- **品質チェック機能の完全実装** (#45, #46, #47): 型定義品質の自動検査とレポート生成
  - 型レベル比率の自動計算と閾値チェック（Level 1/2/3）
  - ドキュメント実装率と詳細度の評価
  - プリミティブ型使用箇所の検出
  - Pydantic型への置き換え推奨（DirectoryPath, FilePath, NonNegativeInt等）
  - プロジェクト固有型定義の検討推奨
  - 総合スコア算出と改善プランの提示
  - `pylay quality`コマンドでCLIから実行可能
- **git tagメッセージとCHANGELOGの自動連携**: リリース時のドキュメント更新を自動化

### 改善
- **型安全性の向上**: 全モジュールでNewTypeパターンを採用し、ランタイムバリデーションを保証
- **コード品質の標準化**: 品質チェック機能により、型定義の一貫性を自動検証
- **テストカバレッジの向上**: 品質チェック機能のテストケースを追加（391個のテスト通過）

### 技術的改善
- **Level 2型定義の標準化**: NewType + ファクトリ関数 + TypeAdapterパターンの確立
- **品質基準の明確化**: pyproject.tomlで型レベル閾値とエラー条件を設定可能
- **CI/CDパイプラインの強化**: `make ci`で品質チェックを含む全検証を実行

---

## [0.3.0] - 2025年10月

### 新機能
- **ユーザー向けドキュメントの完全整備**: README.mdと自動生成ドキュメントの大幅改善
  - CLIツールの詳細な使用例と設定方法を追加
  - 新機能（type: ignore診断、プロジェクト全体解析）の使用方法を明記
  - 設定ファイル（pyproject.toml）の詳細なドキュメントを追加
- **ドキュメント生成システムの安定化**: プロジェクト全体解析による自動ドキュメント生成の改善
  - エラーハンドリングの強化とフォールバック処理の実装
  - 出力ファイル管理の統一（YAML/Markdown/依存関係グラフ）
- **品質チェックの自動化**: リリース前の品質チェックプロセスを標準化
  - 型チェック（mypy + pyright）の厳格化
  - テストカバレッジの継続的改善（66%達成）
  - リンター（ruff）の自動修正機能の強化

### 改善
- **CLI出力の安定性向上**: エラーメッセージとプログレス表示の改善
- **プロジェクト解析の堅牢化**: 大規模プロジェクトでのメモリ使用量最適化
- **テストスイートの拡張**: 296個のテストケースで機能の完全網羅

### 修正
- **ドキュメント生成エラーの一部修正**: 一部の複雑な型定義でのMarkdown生成エラーを改善
- **依存関係抽出の精度向上**: 循環参照検出アルゴリズムの強化

### 技術的改善
- **開発ワークフローの効率化**: Makefileコマンドの活用による開発生産性の向上
- **型安全性の継続的強化**: Python 3.13標準構文の積極的採用
- **エラーハンドリングの統一**: Pydanticベースのエラー処理標準化

---

### 新機能
- **型定義レベル分析・監視機能** (#24): Python 3.13の型定義レベル（Level 1/2/3）を自動分類・分析する機能を実装
  - **3段階の型レベル分類**: `type`エイリアス（Level 1）、`Annotated`+バリデータ（Level 2）、`BaseModel`（Level 3）を自動検出
  - **型レベルアップ推奨エンジン**: 使用状況とパターン分析に基づく自動的な型昇格/降格推奨
  - **ドキュメント品質分析**: docstringの実装率、詳細度、総合品質スコアを算出
  - **カスタム閾値設定**: 型レベル比率とドキュメント品質の警告閾値をカスタマイズ可能
  - **Rich統合のCLI出力**: 美しいテーブル形式での統計表示と優先度付き推奨事項
  - **analyze-typesコマンド**: トップレベルCLIコマンドとして型レベル分析を実行
- **Analyzerアーキテクチャの導入**: `src/core/analyzer/` を新規作成し、解析エンジンを独立化
- **高度な型推論と依存抽出**: mypy + AST + NetworkXを活用した包括的な解析機能
- **循環依存検出**: 依存グラフから自動的に循環を検出・報告
- **視覚化機能**: 依存関係をPNG/PDF/DOT形式で自動生成
- **柔軟な解析モード**: `types_only`, `deps_only`, `full` の3モードを選択可能
- **GraphProcessor**: グラフメトリクス計算とYAML/GraphMLエクスポート機能を追加

### 改善
- **型参照カウントの精度向上**: AST解析による正確な型使用回数カウント（型エイリアス定義内の参照も検出）
- **型エイリアス検出の強化**: `type`文と代入形式（`TypeAlias = ...`）の両方をサポート
- **型定義重複除去**: ファイルパス・名前・行番号の組み合わせキーによる正確な重複判定
- **docstring分析の充実**: Google/NumPy/reStructuredText形式の検出と詳細度スコアリング
- **TypeReporterのコード品質**: docstring充実化、エッジケース処理の明確化、防御的プログラミングの実践
- **疎結合アーキテクチャ**: 解析部分を他のコンポーネントから独立させ、拡張性を向上
- **型安全性強化**: Pydanticで型安全性を維持しつつ、柔軟な依存処理を実現
- **CLI強化**: `infer-deps` コマンドと `--mode` オプションを追加
- **ドキュメント自動生成**: 解析結果にグラフ情報（循環、統計）を自動追加
- **テストスイート拡張**: `test_analyzer.py` を追加し、19テストで完全網羅

### 修正
- **型エイリアス参照カウント**: `visit_TypeAlias`メソッド追加により、型エイリアス定義内の型参照を正しくカウント
- **閾値設定の修正**: `threshold_ratios`から型レベル閾値とドキュメント閾値を正しく分離・適用
- **未使用型判定の修正**: 型使用回数カウントをAST解析ベースに改善し、誤判定を解消
- **削除推奨から調査推奨へ**: プロジェクトポリシーに基づき、未使用型は削除ではなく調査対象として推奨
- **型チェックエラー修正**: Pyright/mypyの厳格モード下での全エラーを解消
- **コンソール出力の改善**: 末尾の`None`表示削除、テーブルスタイルの統一、色の一貫性向上
- **CIエラー修正**: テストのimportエラーとNetworkX依存を適切に処理
- **構文エラー修正**: `src/infer_deps.py` のtry-except構造を修正
- **カバレッジ向上**: 78% → 80%目標に近づくテスト追加

### 技術的改善
- **`from __future__ import annotations`の導入**: 文字列リテラル型アノテーションを削除し、Python 3.13標準構文に統一
- **AST Visitor パターン**: `_TypeReferenceCounter`による効率的な型参照カウント（関数引数、戻り値、変数アノテーション、クラス定義、型エイリアス）
- **3つのレベル判定ロジック**: パターンマッチング、使用回数、docstring指示を統合した高度な判定エンジン
- **Makefileコマンド追加**: `make analyze`で型レベル分析を簡単に実行可能
- **NetworkX統合**: グラフ分析機能を標準化（未インストール時も基本動作OK）
- **依存関係管理**: analyzerモジュールの循環import回避
- **エラーハンドリング**: NetworkX/Pydot未インストール時の適切なフォールバック

---

## [0.2.0] - 2025年1月

### 新機能
- **pyproject.toml設定駆動のディレクトリ丸ごと解析機能**: Issue #5 に対応し、設定ファイルに基づく包括的な型解析・ドキュメント生成機能を追加
- **--cleanオプション**: プロジェクト解析時に出力ディレクトリをクリーンアップする機能を追加
- **OutputPathManager**: 出力ファイル管理を統一し、より堅牢なパス管理を実現

### 改善
- **開発者ガイドの簡素化**: プロジェクトの概念とアーキテクチャを明確に整理
- **docs/ディレクトリの整理**: 散らばった古いYAMLファイルを削除し、出力ディレクトリを`docs/pylay-types/`に統一
- **CIテストエラー修正**: 継続的インテグレーションの安定性を向上

### 修正
- **型解析とテストの修正**: 型推論の精度向上とテストケースの拡充

### 技術的改善
- **バージョン0.2.0**: 安定版リリースに向けたバージョンアップデート
- **依存関係管理**: pyproject.tomlでの設定統一
- **コードベースのクリーンアップ**: 不要ファイルの整理と構造最適化

---

*このCHANGELOGは、[Keep a Changelog](https://keepachangelog.com/ja/1.0.0/)の形式に従っています。*
